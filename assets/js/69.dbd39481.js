(window.webpackJsonp=window.webpackJsonp||[]).push([[69],{395:function(s,a,t){"use strict";t.r(a);var e=t(4),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("div",{staticClass:"custom-block tip"},[t("p",[s._v("ELK 是 ElasticSearch、Logstash、Kibana 的简称，一般用于日志系统，从日志收集，日志转储，日志展示等入手，用以提供简洁高效的日志处理机制。这篇文章记录一下我用 Docker 搭建 ELK，并且结合 logspout 实现自动化地把所有 Docker 容器的日志数据传输给 ELK 的过程。")])]),s._v(" "),t("h2",{attrs:{id:"elk-介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#elk-介绍"}},[s._v("#")]),s._v(" ELK 介绍")]),s._v(" "),t("p",[s._v("ELK 是一套开源实时日志分析系统，由 ElasticSearch、Logstash 和 Kiabana 三个开源工具组成。")]),s._v(" "),t("p",[s._v("官方网站："),t("a",{attrs:{href:"https://www.elastic.co/products",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.elastic.co/products"),t("OutboundLink")],1)]),s._v(" "),t("ul",[t("li",[t("p",[s._v("Elasticsearch：开源分布式搜索引擎，它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful 风格接口，多数据源，自动搜索负载等。")])]),s._v(" "),t("li",[t("p",[s._v("Logstash：一个完全开源的工具，他可以对你的日志进行收集、过滤，并将其存储供以后使用（如，搜索）。")])]),s._v(" "),t("li",[t("p",[s._v("Kibana：一个开源和免费的工具，它可以为 Logstash 和 ElasticSearch 提供的日志分析友好的 Web 界面，可以帮助您汇总、分析和搜索重要数据日志。")])])]),s._v(" "),t("p",[t("img",{attrs:{src:"/images/blog/68/elk.png",alt:"elk"}})]),s._v(" "),t("h2",{attrs:{id:"基础镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基础镜像"}},[s._v("#")]),s._v(" 基础镜像")]),s._v(" "),t("p",[s._v("在构建自己的镜像之前，先把官方的基础镜像拉下来，我这里使用的是 6.2.4 版本。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ docker pull docker.elastic.co/elasticsearch/elasticsearch-oss:6.2.4\n$ docker pull docker.elastic.co/logstash/logstash-oss:6.2.4\n$ docker pull docker.elastic.co/kibana/kibana-oss:6.2.4\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("为避免版本混乱，从 5.0 开始，Elastic 公司将各组件的版本号进行统一。")]),s._v(" "),t("p",[s._v("使用时，各组件版本号应一致。（版本号形式："),t("code",[s._v("x.y.z")]),s._v("， "),t("code",[s._v("z")]),s._v("可以不同）")]),s._v(" "),t("p",[s._v("如果想基于其它版本，可以到 "),t("a",{attrs:{href:"https://www.docker.elastic.co/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.docker.elastic.co/"),t("OutboundLink")],1),s._v(" 查看各版本对应的镜像的 tag。")]),s._v(" "),t("h2",{attrs:{id:"构建镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#构建镜像"}},[s._v("#")]),s._v(" 构建镜像")]),s._v(" "),t("h3",{attrs:{id:"elasticsearch"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#elasticsearch"}},[s._v("#")]),s._v(" ElasticSearch")]),s._v(" "),t("h4",{attrs:{id:"elasticsearch-yml"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#elasticsearch-yml"}},[s._v("#")]),s._v(" elasticsearch.yml")]),s._v(" "),t("p",[s._v("先创建一个配置文件 "),t("code",[s._v("elasticsearch.yml")]),s._v("，添加以下内容：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("network.host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 0.0.0.0\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# minimum_master_nodes need to be explicitly set when bound on a public IP")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# set to 1 to allow single node clusters")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Details: https://github.com/elastic/elasticsearch/pull/17288")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("discovery.zen.minimum_master_nodes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Use single node discovery in order to disable production mode and avoid bootstrap checks")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## see https://www.elastic.co/guide/en/elasticsearch/reference/current/bootstrap-checks.html")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("discovery.type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" single"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("node\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add elasticsearch-head cors support.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("http.cors.enabled")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("http.cors.allow-origin")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("h4",{attrs:{id:"dockerfile"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dockerfile"}},[s._v("#")]),s._v(" Dockerfile")]),s._v(" "),t("p",[s._v("在 "),t("code",[s._v("elasticsearch.yml")]),s._v(" 同个文件夹目录下，创建一个 "),t("code",[s._v("Dockerfile")]),s._v(" 文件，添加以下内容：")]),s._v(" "),t("div",{staticClass:"language-dockerfile line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" docker.elastic.co/elasticsearch/elasticsearch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("oss"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("6.2.4\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" elasticsearch.yml /usr/share/elasticsearch/config/elasticsearch.yml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h4",{attrs:{id:"构建"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#构建"}},[s._v("#")]),s._v(" 构建")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ docker build -t elasticSearch .\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"logstash"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#logstash"}},[s._v("#")]),s._v(" Logstash")]),s._v(" "),t("h4",{attrs:{id:"logstash-yml"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#logstash-yml"}},[s._v("#")]),s._v(" logstash.yml")]),s._v(" "),t("p",[s._v("创建一个配置文件 "),t("code",[s._v("logstash.yml")]),s._v("，添加以下内容")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("http.host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0.0"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path.config")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /usr/share/logstash/pipeline\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h4",{attrs:{id:"logstash-conf"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#logstash-conf"}},[s._v("#")]),s._v(" logstash.conf")]),s._v(" "),t("p",[s._v("再创建一个配置文件 "),t("code",[s._v("logstash.conf")]),s._v("，添加以下内容")]),s._v(" "),t("div",{staticClass:"language-conf line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('input {\n    tcp {\n        port => 5000\n        codec => json\n    }\n    udp {\n        port => 5000\n        codec => json\n    }\n}\n\noutput {\n    elasticsearch {\n        hosts => "elasticsearch:9200"\n    }\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("h4",{attrs:{id:"dockerfile-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dockerfile-2"}},[s._v("#")]),s._v(" Dockerfile")]),s._v(" "),t("div",{staticClass:"language-dockerfile line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" docker.elastic.co/logstash/logstash"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("oss"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("6.2.4\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" logstash.yml /usr/share/logstash/config/logstash.yml\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" logstash.conf /usr/share/logstash/pipeline/logstash.conf\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 5000\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h4",{attrs:{id:"构建-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#构建-2"}},[s._v("#")]),s._v(" 构建")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ docker build -t logstash .\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"kibana"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kibana"}},[s._v("#")]),s._v(" Kibana")]),s._v(" "),t("h4",{attrs:{id:"kibana-yml"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kibana-yml"}},[s._v("#")]),s._v(" kibana.yml")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("server.name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kibana\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("server.host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("elasticsearch.url")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" http"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//elasticsearch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9200")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h4",{attrs:{id:"dockerfile-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dockerfile-3"}},[s._v("#")]),s._v(" Dockerfile")]),s._v(" "),t("div",{staticClass:"language-dockerfile line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" docker.elastic.co/kibana/kibana"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("oss"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("6.2.4\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" kibana.yml /usr/share/kibana/config/kibana.yml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h4",{attrs:{id:"构建-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#构建-3"}},[s._v("#")]),s._v(" 构建")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ docker build -t kibana .\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("至此，ELK 三个镜像我们都已经构建好了。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ docker images\nREPOSITORY        TAG         IMAGE ID         CREATED             SIZE\nelasticsearch     latest      be6f4f0f0b5c     48 minutes ago      424MB\nlogstash          latest      8708312ccbfc     50 minutes ago      657MB\nkibana            latest      b08d2aa33797     About an hour ago   527MB\n...\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h2",{attrs:{id:"docker-compose-运行-elk-容器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose-运行-elk-容器"}},[s._v("#")]),s._v(" Docker compose 运行 ELK 容器")]),s._v(" "),t("p",[s._v("创建一个 "),t("code",[s._v("docker-compose.yml")]),s._v(" 文件，添加以下内容：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("elasticsearch")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" elasticsearch\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" elasticsearch\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./data/elasticsearch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/usr/share/elasticsearch/data\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"9200:9200"')]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("logstash")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" logstash\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" logstash\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5000:5000"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("depends_on")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" elasticsearch\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("links")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" elasticsearch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("elasticsearch\n\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kibana")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kibana\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kibana\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5601:5601"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("depends_on")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" elasticsearch\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("links")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" elasticsearch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("elasticsearch\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br")])]),t("p",[s._v("然后使用 "),t("code",[s._v("docker-compose up")]),s._v(" 命令，即可启动容器服务：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ docker-compose up -d\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("启动完成，查看运行的容器：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('$ docker ps -a\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                        NAMES\n7b4a9825a061        kibana              "/bin/bash /usr/loca…"   About an hour ago   Up About an hour    0.0.0.0:5601->5601/tcp                       kibana\n82e6de4822d4        logstash            "/usr/local/bin/dock…"   About an hour ago   Up About an hour    5044/tcp, 0.0.0.0:5000->5000/tcp, 9600/tcp   logstash\n0aba77e5d6f5        elasticsearch       "/usr/local/bin/dock…"   About an hour ago   Up About an hour    0.0.0.0:9200->9200/tcp, 9300/tcp             elasticsearch\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h2",{attrs:{id:"logspout"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#logspout"}},[s._v("#")]),s._v(" Logspout")]),s._v(" "),t("p",[s._v("到目前为止，ELK 已经搭建完毕，但还没有数据。")]),s._v(" "),t("p",[s._v("想要让某一台服务器上所有的 Docker 容器，都自动将日志输出到 ELK（准确地说是输出到 logstash），还需要一个另外的容器，也就是 Logspout。")]),s._v(" "),t("p",[s._v("具体实现可以看：")]),s._v(" "),t("ul",[t("li",[s._v("bingozb/docker-logspout："),t("a",{attrs:{href:"https://github.com/bingozb/docker-logspout",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/bingozb/docker-logspout"),t("OutboundLink")],1)]),s._v(" "),t("li",[s._v("looplab/logspout-logstash："),t("a",{attrs:{href:"https://github.com/looplab/logspout-logstash",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/looplab/logspout-logstash"),t("OutboundLink")],1)])]),s._v(" "),t("p",[s._v("这里我们直接用起来，使用 "),t("code",[s._v("bingozb/docker-logspout")]),s._v(" 镜像。")]),s._v(" "),t("p",[s._v("在某一台服务器（跟部署了ELK的服务器可以不是同一台）上的 "),t("code",[s._v("docker-compose.yml")]),s._v(" 中，添加 "),t("code",[s._v("logspout")]),s._v(" 服务：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[s._v("  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("logspout")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bingozb/logspout\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" logspout\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /var/run/docker.sock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/var/run/docker.sock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("ro\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ROUTE_URIS")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" logstash"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//localhost"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("LOGSTASH_TAGS")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" docker"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("elk\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("如果是外网部署，"),t("code",[s._v("ROUTE_URIS")]),s._v(" 中的 "),t("code",[s._v("localhost")]),s._v(" 需替换为部署了 ELK 的服务器的 IP。")]),s._v(" "),t("p",[s._v("这样，这台服务器上所有的容器的日志就都会输出到 Logstash，收集后通过 pipeline 存储到 es 中，就可以在 kibana 上看日志了。")]),s._v(" "),t("h2",{attrs:{id:"测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[s._v("#")]),s._v(" 测试")]),s._v(" "),t("p",[s._v("这里我添加一个简单的前后端分离的应用，进行测试。")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[s._v("  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("javaee-zfbh5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bingozb/javaee"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("zfbh5\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" javaee"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("zfbh5\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8088:8080"')]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("web-zfbh5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bingozb/web"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("zfbh5\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" web"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("zfbh5\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8090:80"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("启动后，就可以在 kibana 上看到日志了。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ docker-compose up -d\nelasticsearch is up-to-date\nkibana is up-to-date\nlogstash is up-to-date\nlogspout is up-to-date\nCreating javaee-zfbh5 ... done\nCreating web-zfbh5    ... done\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("访问 "),t("a",{attrs:{href:"http://localhost:5601",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://localhost:5601"),t("OutboundLink")],1),s._v("，查看页面数据。")]),s._v(" "),t("p",[t("img",{attrs:{src:"/images/blog/68/kibana.png",alt:"kibana"}})]),s._v(" "),t("p",[s._v("可以做一个简单的筛选，比如只看 "),t("code",[s._v("message")]),s._v(" 字段，然后搜索 "),t("code",[s._v("INFO")]),s._v("：")]),s._v(" "),t("p",[t("img",{attrs:{src:"/images/blog/68/kibana-message.png",alt:"kibana-message"}})]),s._v(" "),t("h2",{attrs:{id:"后话"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#后话"}},[s._v("#")]),s._v(" 后话")]),s._v(" "),t("p",[s._v("至此，我们通过 ElasticSearch、Logstash、Kibana、Logspout 四个容器，搭建了一套基于 Docker 环境下，自动化地对所有容器的日志进行收集、存储、以及提供前端页面可便捷检索日志的系统。")]),s._v(" "),t("p",[s._v("有了这么一套系统，开发人员再也不需要在每个项目代码中把 log 输出到文件，然后每次查日志的时候连上服务器去翻阅对应的日志文件，现在只需要打开 kibana 即可直接检索。")])])}),[],!1,null,null,null);a.default=n.exports}}]);