<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Docker搭建ELK收集所有容器日志 | Bingo&#39;s Blog</title>
    <meta name="description" content="Stay Hungry, Stay Foolish.">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <script type="text/javascript" src="/js/index.js"></script>
    
    <link rel="preload" href="/assets/css/0.styles.85941b03.css" as="style"><link rel="preload" href="/assets/js/app.f5b0e4b9.js" as="script"><link rel="preload" href="/assets/js/3.89e13237.js" as="script"><link rel="preload" href="/assets/js/1.70547aa9.js" as="script"><link rel="preload" href="/assets/js/69.f6b9af31.js" as="script"><link rel="prefetch" href="/assets/js/10.3c6fb3a5.js"><link rel="prefetch" href="/assets/js/11.2eeb7c65.js"><link rel="prefetch" href="/assets/js/12.f1e8e228.js"><link rel="prefetch" href="/assets/js/13.b4fb8d3d.js"><link rel="prefetch" href="/assets/js/14.6045def3.js"><link rel="prefetch" href="/assets/js/15.e554eb44.js"><link rel="prefetch" href="/assets/js/16.1fdaf0b8.js"><link rel="prefetch" href="/assets/js/17.20eac420.js"><link rel="prefetch" href="/assets/js/18.62757d19.js"><link rel="prefetch" href="/assets/js/19.949d2427.js"><link rel="prefetch" href="/assets/js/20.b6853c64.js"><link rel="prefetch" href="/assets/js/21.e073a224.js"><link rel="prefetch" href="/assets/js/22.829ce412.js"><link rel="prefetch" href="/assets/js/23.67b3cc57.js"><link rel="prefetch" href="/assets/js/24.54454a6e.js"><link rel="prefetch" href="/assets/js/25.d2758f74.js"><link rel="prefetch" href="/assets/js/26.d5a0d37c.js"><link rel="prefetch" href="/assets/js/27.c37293c1.js"><link rel="prefetch" href="/assets/js/28.9aa6999f.js"><link rel="prefetch" href="/assets/js/29.3f834fad.js"><link rel="prefetch" href="/assets/js/30.7013f00b.js"><link rel="prefetch" href="/assets/js/31.e3c61c43.js"><link rel="prefetch" href="/assets/js/32.b24da55c.js"><link rel="prefetch" href="/assets/js/33.3aff4bde.js"><link rel="prefetch" href="/assets/js/34.8d98d620.js"><link rel="prefetch" href="/assets/js/35.621f649b.js"><link rel="prefetch" href="/assets/js/36.a7753580.js"><link rel="prefetch" href="/assets/js/37.768cbc39.js"><link rel="prefetch" href="/assets/js/38.04f6c54b.js"><link rel="prefetch" href="/assets/js/39.bb0f13d7.js"><link rel="prefetch" href="/assets/js/4.fef5f850.js"><link rel="prefetch" href="/assets/js/40.e0310ac2.js"><link rel="prefetch" href="/assets/js/41.0ccf449b.js"><link rel="prefetch" href="/assets/js/42.0c37e550.js"><link rel="prefetch" href="/assets/js/43.b97d0a10.js"><link rel="prefetch" href="/assets/js/44.b1722869.js"><link rel="prefetch" href="/assets/js/45.a4920384.js"><link rel="prefetch" href="/assets/js/46.b3a83985.js"><link rel="prefetch" href="/assets/js/47.0b768238.js"><link rel="prefetch" href="/assets/js/48.fc7f248c.js"><link rel="prefetch" href="/assets/js/49.45fee475.js"><link rel="prefetch" href="/assets/js/5.5714c074.js"><link rel="prefetch" href="/assets/js/50.2a6c399e.js"><link rel="prefetch" href="/assets/js/51.c294f19e.js"><link rel="prefetch" href="/assets/js/52.c91f6423.js"><link rel="prefetch" href="/assets/js/53.5b886803.js"><link rel="prefetch" href="/assets/js/54.ad412bc2.js"><link rel="prefetch" href="/assets/js/55.4d67d273.js"><link rel="prefetch" href="/assets/js/56.6477afcf.js"><link rel="prefetch" href="/assets/js/57.a673b01e.js"><link rel="prefetch" href="/assets/js/58.3d8b0217.js"><link rel="prefetch" href="/assets/js/59.03c8a5a7.js"><link rel="prefetch" href="/assets/js/6.66b43321.js"><link rel="prefetch" href="/assets/js/60.639d6287.js"><link rel="prefetch" href="/assets/js/61.bad972f7.js"><link rel="prefetch" href="/assets/js/62.8f461af5.js"><link rel="prefetch" href="/assets/js/63.616ced2a.js"><link rel="prefetch" href="/assets/js/64.a1a45c9a.js"><link rel="prefetch" href="/assets/js/65.a29a31c2.js"><link rel="prefetch" href="/assets/js/66.a4378271.js"><link rel="prefetch" href="/assets/js/67.e6ab2cd0.js"><link rel="prefetch" href="/assets/js/68.5363b86a.js"><link rel="prefetch" href="/assets/js/7.18d02750.js"><link rel="prefetch" href="/assets/js/70.de6b126e.js"><link rel="prefetch" href="/assets/js/71.84dcd29b.js"><link rel="prefetch" href="/assets/js/72.44f56d8b.js"><link rel="prefetch" href="/assets/js/73.105275e2.js"><link rel="prefetch" href="/assets/js/74.4912560d.js"><link rel="prefetch" href="/assets/js/8.14d68426.js"><link rel="prefetch" href="/assets/js/9.ee282502.js">
    <link rel="stylesheet" href="/assets/css/0.styles.85941b03.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container" data-v-21b9510f><div data-v-21b9510f><div id="loader-wrapper" class="loading-wrapper" data-v-71fac282 data-v-21b9510f data-v-21b9510f><div class="loader-main" data-v-71fac282><div data-v-71fac282></div><div data-v-71fac282></div><div data-v-71fac282></div><div data-v-71fac282></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-6cb76055 data-v-21b9510f data-v-21b9510f><h3 class="title" style="display:none;" data-v-6cb76055 data-v-6cb76055>Bingo's Blog</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-6cb76055 data-v-6cb76055><input type="password" value="" data-v-6cb76055> <span data-v-6cb76055>Konck! Knock!</span> <button data-v-6cb76055>OK</button></label> <div class="footer" style="display:none;" data-v-6cb76055 data-v-6cb76055><span data-v-6cb76055><i class="iconfont reco-theme" data-v-6cb76055></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-6cb76055>vuePress-theme-reco</a></span> <span data-v-6cb76055><i class="iconfont reco-copyright" data-v-6cb76055></i> <a data-v-6cb76055><span data-v-6cb76055>Bingo</span>
            
          <span data-v-6cb76055>2016 - </span>
          2020
        </a></span></div></div> <div class="hide" data-v-21b9510f><header class="navbar" data-v-21b9510f><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Bingo's Blog" class="logo"> <span class="site-name">Bingo's Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/解决方案/" class="nav-link"><i class="iconfont undefined"></i>
  解决方案
</a></li><li class="dropdown-item"><!----> <a href="/categories/战斗笔记/" class="nav-link"><i class="iconfont undefined"></i>
  战斗笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/DKKIT/" class="nav-link"><i class="iconfont undefined"></i>
  DKKIT
</a></li><li class="dropdown-item"><!----> <a href="/categories/工作总结/" class="nav-link"><i class="iconfont undefined"></i>
  工作总结
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/views/about/index.html" class="nav-link"><i class="iconfont reco-message"></i>
  About me
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/bingozb" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-21b9510f></div> <aside class="sidebar" data-v-21b9510f><div class="personal-info-wrapper" data-v-77ccc048><img src="/avatar.jpg" alt="author-avatar" class="personal-img" data-v-77ccc048> <h3 class="name" data-v-77ccc048>
    Bingo
  </h3> <div class="num" data-v-77ccc048><div data-v-77ccc048><h3 data-v-77ccc048>62</h3> <h6 data-v-77ccc048>文章</h6></div> <div data-v-77ccc048><h3 data-v-77ccc048>33</h3> <h6 data-v-77ccc048>标签</h6></div></div> <hr data-v-77ccc048></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/解决方案/" class="nav-link"><i class="iconfont undefined"></i>
  解决方案
</a></li><li class="dropdown-item"><!----> <a href="/categories/战斗笔记/" class="nav-link"><i class="iconfont undefined"></i>
  战斗笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/DKKIT/" class="nav-link"><i class="iconfont undefined"></i>
  DKKIT
</a></li><li class="dropdown-item"><!----> <a href="/categories/工作总结/" class="nav-link"><i class="iconfont undefined"></i>
  工作总结
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/views/about/index.html" class="nav-link"><i class="iconfont reco-message"></i>
  About me
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/bingozb" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Docker搭建ELK收集所有容器日志</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/views/default/68.html#elk-介绍" class="sidebar-link">ELK 介绍</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/default/68.html#基础镜像" class="sidebar-link">基础镜像</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/default/68.html#构建镜像" class="sidebar-link">构建镜像</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/default/68.html#elasticsearch" class="sidebar-link">ElasticSearch</a></li><li class="sidebar-sub-header"><a href="/views/default/68.html#logstash" class="sidebar-link">Logstash</a></li><li class="sidebar-sub-header"><a href="/views/default/68.html#kibana" class="sidebar-link">Kibana</a></li></ul></li><li><a href="/views/default/68.html#docker-compose-运行-elk-容器" class="sidebar-link">Docker compose 运行 ELK 容器</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/default/68.html#logspout" class="sidebar-link">Logspout</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/default/68.html#测试" class="sidebar-link">测试</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/default/68.html#后话" class="sidebar-link">后话</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-6cb76055 data-v-21b9510f><h3 class="title" style="display:none;" data-v-6cb76055 data-v-6cb76055>Docker搭建ELK收集所有容器日志</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-6cb76055 data-v-6cb76055><input type="password" value="" data-v-6cb76055> <span data-v-6cb76055>Konck! Knock!</span> <button data-v-6cb76055>OK</button></label> <div class="footer" style="display:none;" data-v-6cb76055 data-v-6cb76055><span data-v-6cb76055><i class="iconfont reco-theme" data-v-6cb76055></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-6cb76055>vuePress-theme-reco</a></span> <span data-v-6cb76055><i class="iconfont reco-copyright" data-v-6cb76055></i> <a data-v-6cb76055><span data-v-6cb76055>Bingo</span>
            
          <span data-v-6cb76055>2016 - </span>
          2020
        </a></span></div></div> <div data-v-21b9510f><main class="page"><div class="page-title" style="display:none;"><h1>Docker搭建ELK收集所有容器日志</h1> <hr> <div data-v-c4ddd85a><i class="iconfont reco-account" data-v-c4ddd85a><span data-v-c4ddd85a>Bingo</span></i> <i class="iconfont reco-date" data-v-c4ddd85a><span data-v-c4ddd85a>2020-04-16 19:22:48</span></i> <!----> <i class="iconfont reco-tag tags" data-v-c4ddd85a><span class="tag-item" data-v-c4ddd85a>
      ELK
    </span><span class="tag-item" data-v-c4ddd85a>
      CentOS
    </span><span class="tag-item" data-v-c4ddd85a>
      Linux
    </span><span class="tag-item" data-v-c4ddd85a>
      Docker
    </span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><div class="custom-block tip"><p>ELK 是 ElasticSearch、Logstash、Kibana 的简称，一般用于日志系统，从日志收集，日志转储，日志展示等入手，用以提供简洁高效的日志处理机制。这篇文章记录一下我用 Docker 搭建 ELK，并且结合 logspout 实现自动化地把所有 Docker 容器的日志数据传输给 ELK 的过程。</p></div> <h2 id="elk-介绍"><a href="#elk-介绍" class="header-anchor">#</a> ELK 介绍</h2> <p>ELK 是一套开源实时日志分析系统，由 ElasticSearch、Logstash 和 Kiabana 三个开源工具组成。</p> <p>官方网站：<a href="https://www.elastic.co/products" target="_blank" rel="noopener noreferrer">https://www.elastic.co/products<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <ul><li><p>Elasticsearch：开源分布式搜索引擎，它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful 风格接口，多数据源，自动搜索负载等。</p></li> <li><p>Logstash：一个完全开源的工具，他可以对你的日志进行收集、过滤，并将其存储供以后使用（如，搜索）。</p></li> <li><p>Kibana：一个开源和免费的工具，它可以为 Logstash 和 ElasticSearch 提供的日志分析友好的 Web 界面，可以帮助您汇总、分析和搜索重要数据日志。</p></li></ul> <p><img src="/images/blog/68/elk.png" alt="elk"></p> <h2 id="基础镜像"><a href="#基础镜像" class="header-anchor">#</a> 基础镜像</h2> <p>在构建自己的镜像之前，先把官方的基础镜像拉下来，我这里使用的是 6.2.4 版本。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker pull docker.elastic.co/elasticsearch/elasticsearch-oss:6.2.4
$ docker pull docker.elastic.co/logstash/logstash-oss:6.2.4
$ docker pull docker.elastic.co/kibana/kibana-oss:6.2.4
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>为避免版本混乱，从 5.0 开始，Elastic 公司将各组件的版本号进行统一。</p> <p>使用时，各组件版本号应一致。（版本号形式：<code>x.y.z</code>， <code>z</code>可以不同）</p> <p>如果想基于其它版本，可以到 <a href="https://www.docker.elastic.co/" target="_blank" rel="noopener noreferrer">https://www.docker.elastic.co/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 查看各版本对应的镜像的 tag。</p> <h2 id="构建镜像"><a href="#构建镜像" class="header-anchor">#</a> 构建镜像</h2> <h3 id="elasticsearch"><a href="#elasticsearch" class="header-anchor">#</a> ElasticSearch</h3> <h4 id="elasticsearch-yml"><a href="#elasticsearch-yml" class="header-anchor">#</a> elasticsearch.yml</h4> <p>先创建一个配置文件 <code>elasticsearch.yml</code>，添加以下内容：</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token punctuation">---</span>
<span class="token key atrule">network.host</span><span class="token punctuation">:</span> 0.0.0.0

<span class="token comment"># minimum_master_nodes need to be explicitly set when bound on a public IP</span>
<span class="token comment"># set to 1 to allow single node clusters</span>
<span class="token comment"># Details: https://github.com/elastic/elasticsearch/pull/17288</span>
<span class="token key atrule">discovery.zen.minimum_master_nodes</span><span class="token punctuation">:</span> <span class="token number">1</span>

<span class="token comment">## Use single node discovery in order to disable production mode and avoid bootstrap checks</span>
<span class="token comment">## see https://www.elastic.co/guide/en/elasticsearch/reference/current/bootstrap-checks.html</span>
<span class="token comment">#</span>
<span class="token key atrule">discovery.type</span><span class="token punctuation">:</span> single<span class="token punctuation">-</span>node

<span class="token comment"># add elasticsearch-head cors support.</span>
<span class="token key atrule">http.cors.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">http.cors.allow-origin</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="dockerfile"><a href="#dockerfile" class="header-anchor">#</a> Dockerfile</h4> <p>在 <code>elasticsearch.yml</code> 同个文件夹目录下，创建一个 <code>Dockerfile</code> 文件，添加以下内容：</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> docker.elastic.co/elasticsearch/elasticsearch<span class="token punctuation">-</span>oss<span class="token punctuation">:</span>6.2.4
<span class="token keyword">COPY</span> elasticsearch.yml /usr/share/elasticsearch/config/elasticsearch.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="构建"><a href="#构建" class="header-anchor">#</a> 构建</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker build -t elasticSearch .
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="logstash"><a href="#logstash" class="header-anchor">#</a> Logstash</h3> <h4 id="logstash-yml"><a href="#logstash-yml" class="header-anchor">#</a> logstash.yml</h4> <p>创建一个配置文件 <code>logstash.yml</code>，添加以下内容</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">http.host</span><span class="token punctuation">:</span> <span class="token string">&quot;0.0.0.0&quot;</span>
<span class="token key atrule">path.config</span><span class="token punctuation">:</span> /usr/share/logstash/pipeline
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="logstash-conf"><a href="#logstash-conf" class="header-anchor">#</a> logstash.conf</h4> <p>再创建一个配置文件 <code>logstash.conf</code>，添加以下内容</p> <div class="language-conf line-numbers-mode"><pre class="language-text"><code>input {
    tcp {
        port =&gt; 5000
        codec =&gt; json
    }
    udp {
        port =&gt; 5000
        codec =&gt; json
    }
}

output {
    elasticsearch {
        hosts =&gt; &quot;elasticsearch:9200&quot;
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="dockerfile-2"><a href="#dockerfile-2" class="header-anchor">#</a> Dockerfile</h4> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> docker.elastic.co/logstash/logstash<span class="token punctuation">-</span>oss<span class="token punctuation">:</span>6.2.4
<span class="token keyword">COPY</span> logstash.yml /usr/share/logstash/config/logstash.yml
<span class="token keyword">COPY</span> logstash.conf /usr/share/logstash/pipeline/logstash.conf
<span class="token keyword">EXPOSE</span> 5000
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="构建-2"><a href="#构建-2" class="header-anchor">#</a> 构建</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker build -t logstash .
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="kibana"><a href="#kibana" class="header-anchor">#</a> Kibana</h3> <h4 id="kibana-yml"><a href="#kibana-yml" class="header-anchor">#</a> kibana.yml</h4> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server.name</span><span class="token punctuation">:</span> kibana
<span class="token key atrule">server.host</span><span class="token punctuation">:</span> <span class="token string">&quot;0&quot;</span>
<span class="token key atrule">elasticsearch.url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//elasticsearch<span class="token punctuation">:</span><span class="token number">9200</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="dockerfile-3"><a href="#dockerfile-3" class="header-anchor">#</a> Dockerfile</h4> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> docker.elastic.co/kibana/kibana<span class="token punctuation">-</span>oss<span class="token punctuation">:</span>6.2.4
<span class="token keyword">COPY</span> kibana.yml /usr/share/kibana/config/kibana.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="构建-3"><a href="#构建-3" class="header-anchor">#</a> 构建</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker build -t kibana .
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>至此，ELK 三个镜像我们都已经构建好了。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker images
REPOSITORY        TAG         IMAGE ID         CREATED             SIZE
elasticsearch     latest      be6f4f0f0b5c     48 minutes ago      424MB
logstash          latest      8708312ccbfc     50 minutes ago      657MB
kibana            latest      b08d2aa33797     About an hour ago   527MB
...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="docker-compose-运行-elk-容器"><a href="#docker-compose-运行-elk-容器" class="header-anchor">#</a> Docker compose 运行 ELK 容器</h2> <p>创建一个 <code>docker-compose.yml</code> 文件，添加以下内容：</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;2&quot;</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">image</span><span class="token punctuation">:</span> elasticsearch
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> elasticsearch
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./data/elasticsearch<span class="token punctuation">:</span>/usr/share/elasticsearch/data
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;9200:9200&quot;</span>

  <span class="token key atrule">logstash</span><span class="token punctuation">:</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">image</span><span class="token punctuation">:</span> logstash
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> logstash
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;5000:5000&quot;</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elasticsearch
    <span class="token key atrule">links</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elasticsearch<span class="token punctuation">:</span>elasticsearch

  <span class="token key atrule">kibana</span><span class="token punctuation">:</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">image</span><span class="token punctuation">:</span> kibana
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> kibana
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;5601:5601&quot;</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elasticsearch
    <span class="token key atrule">links</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elasticsearch<span class="token punctuation">:</span>elasticsearch
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>然后使用 <code>docker-compose up</code> 命令，即可启动容器服务：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker-compose up -d
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>启动完成，查看运行的容器：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker ps -a
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                        NAMES
7b4a9825a061        kibana              &quot;/bin/bash /usr/loca…&quot;   About an hour ago   Up About an hour    0.0.0.0:5601-&gt;5601/tcp                       kibana
82e6de4822d4        logstash            &quot;/usr/local/bin/dock…&quot;   About an hour ago   Up About an hour    5044/tcp, 0.0.0.0:5000-&gt;5000/tcp, 9600/tcp   logstash
0aba77e5d6f5        elasticsearch       &quot;/usr/local/bin/dock…&quot;   About an hour ago   Up About an hour    0.0.0.0:9200-&gt;9200/tcp, 9300/tcp             elasticsearch
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="logspout"><a href="#logspout" class="header-anchor">#</a> Logspout</h2> <p>到目前为止，ELK 已经搭建完毕，但还没有数据。</p> <p>想要让某一台服务器上所有的 Docker 容器，都自动将日志输出到 ELK（准确地说是输出到 logstash），还需要一个另外的容器，也就是 Logspout。</p> <p>具体实现可以看：</p> <ul><li>bingozb/docker-logspout：<a href="https://github.com/bingozb/docker-logspout" target="_blank" rel="noopener noreferrer">https://github.com/bingozb/docker-logspout<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>looplab/logspout-logstash：<a href="https://github.com/looplab/logspout-logstash" target="_blank" rel="noopener noreferrer">https://github.com/looplab/logspout-logstash<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>这里我们直接用起来，使用 <code>bingozb/docker-logspout</code> 镜像。</p> <p>在某一台服务器（跟部署了ELK的服务器可以不是同一台）上的 <code>docker-compose.yml</code> 中，添加 <code>logspout</code> 服务：</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code>  <span class="token key atrule">logspout</span><span class="token punctuation">:</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">image</span><span class="token punctuation">:</span> bingozb/logspout
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> logspout
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/run/docker.sock<span class="token punctuation">:</span>/var/run/docker.sock<span class="token punctuation">:</span>ro
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">ROUTE_URIS</span><span class="token punctuation">:</span> logstash<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">5000</span>
      <span class="token key atrule">LOGSTASH_TAGS</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>elk
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>如果是外网部署，<code>ROUTE_URIS</code> 中的 <code>localhost</code> 需替换为部署了 ELK 的服务器的 IP。</p> <p>这样，这台服务器上所有的容器的日志就都会输出到 Logstash，收集后通过 pipeline 存储到 es 中，就可以在 kibana 上看日志了。</p> <h2 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h2> <p>这里我添加一个简单的前后端分离的应用，进行测试。</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code>  <span class="token key atrule">javaee-zfbh5</span><span class="token punctuation">:</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">image</span><span class="token punctuation">:</span> bingozb/javaee<span class="token punctuation">-</span>zfbh5
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> javaee<span class="token punctuation">-</span>zfbh5
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;8088:8080&quot;</span>

  <span class="token key atrule">web-zfbh5</span><span class="token punctuation">:</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">image</span><span class="token punctuation">:</span> bingozb/web<span class="token punctuation">-</span>zfbh5
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>zfbh5
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;8090:80&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>启动后，就可以在 kibana 上看到日志了。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker-compose up -d
elasticsearch is up-to-date
kibana is up-to-date
logstash is up-to-date
logspout is up-to-date
Creating javaee-zfbh5 ... done
Creating web-zfbh5    ... done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>访问 <a href="http://localhost:5601" target="_blank" rel="noopener noreferrer">http://localhost:5601<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，查看页面数据。</p> <p><img src="/images/blog/68/kibana.png" alt="kibana"></p> <p>可以做一个简单的筛选，比如只看 <code>message</code> 字段，然后搜索 <code>INFO</code>：</p> <p><img src="/images/blog/68/kibana-message.png" alt="kibana-message"></p> <h2 id="后话"><a href="#后话" class="header-anchor">#</a> 后话</h2> <p>至此，我们通过 ElasticSearch、Logstash、Kibana、Logspout 四个容器，搭建了一套基于 Docker 环境下，自动化地对所有容器的日志进行收集、存储、以及提供前端页面可便捷检索日志的系统。</p> <p>有了这么一套系统，开发人员再也不需要在每个项目代码中把 log 输出到文件，然后每次查日志的时候连上服务器去翻阅对应的日志文件，现在只需要打开 kibana 即可直接检索。</p></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2020/4/16 下午9:24:28</span></div></footer> <!----></main> <!----> <div style="display:none;" data-v-21b9510f data-v-21b9510f><div class="comments-wrapper" data-v-21b9510f><div class="valine-wrapper"><div id="valine"></div></div></div></div></div></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-1e128e82 data-v-1e128e82><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-1e128e82><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-1e128e82></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-1e128e82></path></svg></div></div></div>
    <script src="/assets/js/app.f5b0e4b9.js" defer></script><script src="/assets/js/3.89e13237.js" defer></script><script src="/assets/js/1.70547aa9.js" defer></script><script src="/assets/js/69.f6b9af31.js" defer></script>
  </body>
</html>
