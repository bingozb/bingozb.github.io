---
title: Git操作规范
date: 2017-03-06 11:31:34
categories: 工作总结
tags: [Git, Android, iOS]
---

## 前言

团队项目开发中，遵循一个合理、清晰的 Git 使用流程，是非常重要的。创建项目、迁入团队、代码提交、合并commit、分支管理等都需要有规范。

<!-- more -->

## 规范

#### 项目创建

1. 在 coding.net 创建某项目，项目名称请遵循 `[项目组名称_项目名称(统一小写)]` 原则，例如 `ios_sfddj` ，并在创建的同时添加成员 `dankal_origin` 进入该项目组。

2. 请为项目添加一个该项目的 logo，方便团队管理者查看。如果在开发前期没有该 logo，请联系设计师快速设计一个简易的 logo。

#### 迁入团队

将该项目迁入【蛋壳】团队项目，注意：迁入后项目的远程地址将改变，请注意更换本地仓库的远程仓库地址。 

#### 分支管理

就目前来说，一般的项目分支结构应该是这样的，master 分支用于发布，dev 分支作为开发的总分支，除此两条常设分支外，每个开发人员一条基于 dev 的分支，用于每个人的开发。

- master
- dev
    - 开发者1
    - 开发者2
    - 开发者n

master 分支作为稳定的版本分支，只有发布到生产环境的时候才把 dev 合并到 master 上，并要求打 tag 对应版本号。

dev 分支作为开发环境的总分支，由一个项目负责人专门合并代码到 dev 分支上。

开发者只从 dev 分支 pull，不允许开发者之间相互 merge 代码。

#### 代码提交

Git 每次提交代码，都要写 Commit message（提交说明）。

```
$ git commit -m "mark something."
```

一般来说，commit message 应该清晰明了，说明本次提交的目的，概括本次代码修改的内容，如 “添加注册登录”、“修复注册后不能自动登录的bug” 等，尽量不要出现 “一些小改动”，“改了一点小东西” 这种不知所谓的 message。

当然，这对于开发者个人的分支来说不是硬性要求，有时候确实就是改了一点很小的东西没什么好写的，本着随时可以 commit 的原则这是可以接受的，只能说尽量不要出现这种现象。

但是，dev 分支和 master 分支就不同。dev 和 master 强制要求不能出现这种不知所谓的提交信息，负责人在合并代码提交到这两条的时候，一定要合并 commit，不管是用 rebase 还是 reset，一定要确保 message 是有意义的。

#### 合并提交

最好每个开发者都有合并 commit 的意识，但项目负责人必须合并提交，有两种方式。

##### 方式一、rebase

```
$ git rebase -i origin/master
```

git rebase 命令的 i 参数表示互动（interactive），这时git会打开一个互动界面，进行下一步操作。

下面采用 [Tute Costa](https://robots.thoughtbot.com/git-interactive-rebase-squash-amend-rewriting-history) 的例子，来解释怎么合并 Commit。

```
pick 07c5abd Introduce OpenPGP and teach basic usage
pick de9b1eb Fix PostChecker::Post#urls
pick 3e7ee36 Hey kids, stop all the highlighting
pick fa20af3 git interactive rebase, squash, amend

# Rebase 8db7e8b..fa20af3 onto 8db7e8b
#
# Commands:
#  p, pick = use commit
#  r, reword = use commit, but edit the commit message
#  e, edit = use commit, but stop for amending
#  s, squash = use commit, but meld into previous commit
#  f, fixup = like "squash", but discard this commit's log message
#  x, exec = run command (the rest of the line) using shell
#
# These lines can be re-ordered; they are executed from top to bottom.
#
# If you remove a line here THAT COMMIT WILL BE LOST.
#
# However, if you remove everything, the rebase will be aborted.
#
# Note that empty commits are commented out
```

上面的互动界面，先列出当前分支最新的4个 commit（越下面越新）。每个 commit 前面有一个操作命令，默认是 pick，表示该行 commit 被选中，要进行 rebase 操作。

4个 commit 的下面是一大堆注释，列出可以使用的命令。

命令 | 说明
---|---
pick | 正常选中
reword | 选中，并且修改提交信息
edit | 选中，rebase时会暂停，允许你修改这个commit（参考[这里](https://git-scm.com/book/en/v2)）
squash | 选中，会将当前commit与上一个commit合并
fixup | 与squash相同，但不会保存当前commit的提交信息
exec | 执行其他shell命令

上面这6个命令当中，squash 和 fixup 可以用来合并commit。先把需要合并的commit前面的动词，改成 squash（或者s）。

```
pick 07c5abd Introduce OpenPGP and teach basic usage
s de9b1eb Fix PostChecker::Post#urls
s 3e7ee36 Hey kids, stop all the highlighting
pick fa20af3 git interactive rebase, squash, amend
```

这样一改，执行后，当前分支只会剩下两个commit。第二行和第三行的commit，都会合并到第一行的commit。提交信息会同时包含，这三个commit的提交信息。

```
# This is a combination of 3 commits.
# The first commit's message is:
Introduce OpenPGP and teach basic usage

# This is the 2nd commit message:
Fix PostChecker::Post#urls

# This is the 3rd commit message:
Hey kids, stop all the highlighting
```

如果将第三行的 squash 命令改成 fixup 命令。

```
pick 07c5abd Introduce OpenPGP and teach basic usage
s de9b1eb Fix PostChecker::Post#urls
f 3e7ee36 Hey kids, stop all the highlighting
pick fa20af3 git interactive rebase, squash, amend
```

运行结果相同，还是会生成两个commit，第二行和第三行的commit，都合并到第一行的commit。但是，新的提交信息里面，第三行commit的提交信息，会被注释掉。

```
# This is a combination of 3 commits.
# The first commit's message is:
Introduce OpenPGP and teach basic usage

# This is the 2nd commit message:
Fix PostChecker::Post#urls

# This is the 3rd commit message:
# Hey kids, stop all the highlighting
```

如果不想让别人看到合并 commit 的 message 怎么办？

回答：用 fixup (f)

##### 方式二、reset

另外一种合并 commit 的简便方法，就是先撤销之前的 commit，然后再建一个新的 commit。

```
$ git reset HEAD~n 
```

n 是撤销的Commit的个数，例如上述情景要撤销4个 commit，eg.

```
$ git reset HEAD~4 
$ git add .
$ git commit -am "Here's the bug fix that closes #28"
$ git push --force
```

这样就可以把前面的4个 commit 撤掉，然后重新 commit 了一次，也就起到了合并 commit 的效果。